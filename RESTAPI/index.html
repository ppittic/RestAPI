<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Tickets</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>
</head>
<body>
    <!--AJAX used to call the web API. jQuery used to make the AJAX calls and also to update the page with the results.-->

    <div class="form-group">
        <label for="ticketId">Id:</label>
        <input type="text" class="form-control" id="ticketId">
        <label for="Reporter">Reporter:</label>
        <input type="text" class="form-control" id="Reporter">
        <label for="Reporter">Message:</label>
        <input type="text" class="form-control" id="Message">
    </div>

    <div class="btn-group">
        <button type="button" onclick="find();" class="btn btn-info">Search</button>
        <button type="button" onclick="deleteTicket();" class="btn btn-info">Delete</button>
        <button type="button" onclick="putTicket();" class="btn btn-info">Put</button>
        <button type="button" onclick="postTicket();" class="btn btn-info">Post</button>
        <button type="button" onclick="patchTicket();" class="btn btn-info">Patch</button>
        <button type="button" onclick="showAll();" class="btn btn-primary">Show All Tickets</button>
        <p id="ticket" />
    </div>

    <div>
        <p class="bg-info" id="AllTickets" hidden>All Tickets</p>
        <ul id="tickets" class="list-group" />
    </div>

    <script>
        var uri = 'api/tickets';

        function showAll() {
            // Send an AJAX request
            $.getJSON(uri)
                .done(function (data) {
                    // On success, 'data' contains a list of products.
                    $.each(data, function (key, item) {
                        // Add a list item for the product.
                        $('<li>', { text: formatItem(item) }).appendTo($('#tickets'));
                        $('#AllTickets').show();
                    });
                })
                .fail(function (jqXHR, textStatus, err) {
                    $('#AllTickets').text('Error: ' + err);

                    if (err == "Critical Exception")
                        alert("Critical");
                    else
                        alert('getJSON request failed! ' + textStatus + "err:" + err);
                });
        }

        function formatItem(item) {
            return item.id + " Reporter: " + item.Reporter + ' MSG: ' + item.Message;
        }

        function find() {
            var id = $('#ticketId').val();
            /*$.ajaxSetup({
                headers: {
                    'Accept-Encoding': 'gzip'
               }
             });
            */
            $.getJSON(uri + '/' + id)
                .done(function (data) {
                    $('#ticket').text(formatItem(data));
                })
                .fail(function (jqXHR, textStatus, err) {
                    $('#ticket').text('Error: ' + err + "text status" + textStatus);

                    if (jqXHR.status == 404) {
                        alert("404 Not Found");
                    } else {
                        alert("Other non-handled error type");
                    }
                });
        }

        function deleteTicket() {
            var id = $('#ticketId').val();
            $.ajax({
                url: uri + '/' + id,
                type: 'DELETE',
                success: function (result) {
                    $('#ticket').text(id + 'deleted');
                },
                fail: function (jqXHR, textStatus, err) {
                    $('#ticket').text('Error: ' + err + "text status" + textStatus);
                }
            });
        }
        //
        function postTicket() {
            var id = $('#ticketId').val();
            var reporter = $('#Reporter').val();
            var message = $('#Message').val();
            $.ajax({
                url: uri + '/' + id + '/' + reporter + '/' + message,
                type: 'POST',
                success: function (result) {
                    $('#ticket').text(id + reporter + message + 'Inserted');
                },
                fail: function (jqXHR, textStatus, err) {
                    $('#ticket').text('Error: ' + err + "text status" + textStatus);
                }
            });
        }
        function putTicket() {
            var id = $('#ticketId').val();
            var reporter = $('#Reporter').val();
            var message = $('#Message').val();
            $.ajax({
                url: uri + '/' + id + '/' + reporter + '/' + message,
                type: 'PUT',
                success: function (result) {
                    $('#ticket').text(id + reporter + message + 'PUT');
                },
                fail: function (jqXHR, textStatus, err) {
                    $('#ticket').text('Error: ' + err + "text status" + textStatus);
                }
            });
        }
        //
        function patchTicket() {
            var id = $('#ticketId').val();
            var message = $('#Message').val();
            $.ajax({
                url: uri + '/' + id + '/' + message,
                type: 'PATCH',
                success: function (result) {
                    $('#ticket').text(id + 'patched' + message);
                },
                fail: function (jqXHR, textStatus, err) {
                    $('#ticket').text('Error: ' + err + "text status" + textStatus);
                }
            });
        }
    </script>
</body>
</html>